{% extends "base.html" %}

{% block title %}Markets - Poly-Maker{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <h1>Markets</h1>
    <div>
        <span class="badge badge-success" style="font-size: 0.9rem; padding: 6px 12px;">
            {{ selected_count }} Selected
        </span>
    </div>
</div>

<!-- Search and Filter -->
<div class="card mb-20">
    <form method="get" action="/markets">
        <div class="search-bar" style="flex-wrap: wrap; gap: 15px;">
            <input type="text" name="search" placeholder="Search markets..." value="{{ search }}" style="flex: 2; min-width: 200px;">

            <select name="sort" style="width: 150px;" onchange="this.form.submit()">
                <option value="score" {% if sort == 'score' %}selected{% endif %}>Best Score</option>
                <option value="reward" {% if sort == 'reward' %}selected{% endif %}>Highest Reward</option>
                <option value="volatility" {% if sort == 'volatility' %}selected{% endif %}>Lowest Volatility</option>
                <option value="spread" {% if sort == 'spread' %}selected{% endif %}>Tightest Spread</option>
            </select>

            <select name="max_volatility" style="width: 140px;" onchange="this.form.submit()">
                <option value="" {% if not max_volatility %}selected{% endif %}>Any Volatility</option>
                <option value="10" {% if max_volatility == 10 %}selected{% endif %}>Vol &lt; 10</option>
                <option value="20" {% if max_volatility == 20 %}selected{% endif %}>Vol &lt; 20</option>
                <option value="50" {% if max_volatility == 50 %}selected{% endif %}>Vol &lt; 50</option>
            </select>

            <select name="limit" style="width: 100px;" onchange="this.form.submit()">
                <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if limit == 100 %}selected{% endif %}>100</option>
                <option value="250" {% if limit == 250 %}selected{% endif %}>250</option>
                <option value="500" {% if limit == 500 %}selected{% endif %}>500</option>
            </select>

            <label style="display: flex; align-items: center; gap: 8px; color: #e0e0e0; margin: 0; white-space: nowrap;">
                <input type="checkbox" name="show_selected" value="true" {% if show_selected %}checked{% endif %}
                       style="width: auto;" onchange="this.form.submit()">
                Selected only
            </label>

            <button type="submit" class="btn btn-primary">Search</button>
            {% if search or show_selected or max_volatility or sort != 'score' %}
            <a href="/markets" class="btn btn-secondary">Clear</a>
            {% endif %}
        </div>
    </form>
</div>

<!-- Markets Table -->
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <span class="card-title">
            {% if show_selected %}Selected Markets{% elif search %}Search Results{% else %}All Markets{% endif %}
            <span class="text-muted" style="font-weight: normal;">({{ markets|length }})</span>
        </span>
        {% if show_selected %}
        <button type="button" id="saveChangesBtn" class="btn btn-success" style="display: none;" onclick="saveEventSettings()">
            Save Changes
        </button>
        {% endif %}
    </div>

    {% if markets %}
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th style="width: 30%;">Market</th>
                    <th>Score</th>
                    <th>Bid/Ask</th>
                    <th>Reward/100</th>
                    <th>Volatility</th>
                    <th>Min Size</th>
                    <th>Neg Risk</th>
                    <th>Event Date</th>
                    {% if show_selected %}
                    <th>Exit Before</th>
                    {% endif %}
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for market in markets %}
                {% set is_selected = market.question in selected_questions %}
                <tr style="{% if is_selected %}background: rgba(0, 212, 170, 0.05);{% endif %}">
                    <td>
                        <div style="max-width: 400px;">
                            <a href="https://polymarket.com/event/{{ market.event_slug or market.market_slug }}"
                               target="_blank"
                               style="font-weight: 500; color: #fff; margin-bottom: 4px; text-decoration: none;"
                               title="{{ market.question }}"
                               onmouseover="this.style.textDecoration='underline'"
                               onmouseout="this.style.textDecoration='none'">
                                {{ market.question[:60] }}{% if market.question|length > 60 %}...{% endif %}
                            </a>
                            <div class="text-muted" style="font-size: 0.8rem;">
                                {{ market.answer1 }} / {{ market.answer2 }}
                            </div>
                        </div>
                    </td>
                    <td>
                        {% if market.composite_score is not none %}
                        <span class="{% if market.composite_score > 1 %}text-success{% elif market.composite_score > 0 %}text-warning{% else %}text-muted{% endif %}"
                              style="font-weight: 600;">
                            {{ "%.1f"|format(market.composite_score) }}
                        </span>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="text-success">{{ "%.2f"|format(market.best_bid or 0) }}</span>
                        /
                        <span class="text-danger">{{ "%.2f"|format(market.best_ask or 0) }}</span>
                    </td>
                    <td>
                        {% if market.gm_reward_per_100 %}
                        <span class="{% if market.gm_reward_per_100 > 1 %}text-success{% endif %}">
                            ${{ "%.2f"|format(market.gm_reward_per_100) }}
                        </span>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if market.volatility_sum is not none %}
                        <span class="{% if market.volatility_sum < 10 %}text-success{% elif market.volatility_sum < 20 %}text-warning{% else %}text-danger{% endif %}">
                            {{ "%.1f"|format(market.volatility_sum) }}
                        </span>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if market.min_size %}
                        ${{ "%.0f"|format(market.min_size) }}
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if market.neg_risk %}
                        <span class="badge badge-info">Yes</span>
                        {% else %}
                        <span class="text-muted">No</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if show_selected and is_selected %}
                        <input type="date"
                               class="event-date-input"
                               data-question="{{ market.question }}"
                               data-original="{{ market.event_date or '' }}"
                               value="{{ market.event_date or '' }}"
                               style="width: 130px; padding: 4px;"
                               onchange="markChanged(this)">
                        {% else %}
                        <span class="text-muted" style="font-size: 0.85rem;">
                            {{ market.end_date or market.event_date or '-' }}
                        </span>
                        {% endif %}
                    </td>
                    {% if show_selected %}
                    <td style="text-align: center;">
                        {% if is_selected %}
                        <input type="checkbox"
                               class="exit-before-input"
                               data-question="{{ market.question }}"
                               data-original="{{ 'true' if market.exit_before_event else 'false' }}"
                               {% if market.exit_before_event %}checked{% endif %}
                               style="width: 18px; height: 18px; cursor: pointer;"
                               onchange="markChanged(this)">
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    {% endif %}
                    <td>
                        <form method="post" action="/markets/toggle" style="display: inline;">
                            <input type="hidden" name="question" value="{{ market.question }}">
                            <input type="hidden" name="return_search" value="{{ search }}">
                            <input type="hidden" name="return_sort" value="{{ sort }}">
                            <input type="hidden" name="return_limit" value="{{ limit }}">
                            <input type="hidden" name="return_max_volatility" value="{{ max_volatility or '' }}">
                            <input type="hidden" name="return_show_selected" value="{{ 'true' if show_selected else '' }}">
                            {% if is_selected %}
                            <input type="hidden" name="action" value="disable">
                            <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                            {% else %}
                            <input type="hidden" name="action" value="enable">
                            <button type="submit" class="btn btn-primary btn-sm">Add</button>
                            {% endif %}
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        {% if show_selected %}
        <h3>No Markets Selected</h3>
        <p>Search for markets above and add them to start trading.</p>
        {% elif search %}
        <h3>No Markets Found</h3>
        <p>Try a different search term.</p>
        {% else %}
        <h3>No Markets Available</h3>
        <p>Run the data updater to fetch market data.</p>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Legend -->
<div class="card mt-20">
    <div class="card-header">
        <span class="card-title">Column Legend</span>
    </div>
    <div class="grid-3" style="font-size: 0.85rem;">
        <div>
            <strong>Bid/Ask:</strong> Best bid and ask prices. Look for spreads you can capture.
        </div>
        <div>
            <strong>Reward/100:</strong> Estimated daily reward per $100 liquidity from Polymarket's incentive program.
        </div>
        <div>
            <strong>Volatility:</strong> Sum of price movements over multiple timeframes. Lower is better for market making.
        </div>
        <div>
            <strong>Min Size:</strong> Minimum order size required for rewards eligibility.
        </div>
        <div>
            <strong>Neg Risk:</strong> Whether market uses negative risk adapter (affects contract calls).
        </div>
        <div>
            <strong>Event Date:</strong> When the market resolves. Set this to exit positions before the event.
        </div>
        <div>
            <strong>Exit Before:</strong> When checked, bot will exit one-sided positions 1 day before event date.
        </div>
    </div>
</div>

{% if show_selected %}
<script>
let hasUnsavedChanges = false;
let changedSettings = {};

function markChanged(element) {
    const question = element.dataset.question;
    const original = element.dataset.original;
    const current = element.type === 'checkbox' ? (element.checked ? 'true' : 'false') : element.value;

    if (!changedSettings[question]) {
        changedSettings[question] = {};
    }

    if (element.classList.contains('event-date-input')) {
        changedSettings[question].event_date = current;
        changedSettings[question].event_date_changed = (current !== original);
    } else if (element.classList.contains('exit-before-input')) {
        changedSettings[question].exit_before_event = current;
        changedSettings[question].exit_before_changed = (current !== original);
    }

    // Check if any actual changes exist
    hasUnsavedChanges = Object.values(changedSettings).some(settings =>
        settings.event_date_changed || settings.exit_before_changed
    );

    document.getElementById('saveChangesBtn').style.display = hasUnsavedChanges ? 'block' : 'none';
}

async function saveEventSettings() {
    const saveBtn = document.getElementById('saveChangesBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';

    try {
        for (const [question, settings] of Object.entries(changedSettings)) {
            if (settings.event_date_changed || settings.exit_before_changed) {
                // Get current values from inputs
                const dateInput = document.querySelector(`.event-date-input[data-question="${CSS.escape(question)}"]`);
                const checkboxInput = document.querySelector(`.exit-before-input[data-question="${CSS.escape(question)}"]`);

                const formData = new FormData();
                formData.append('question', question);
                formData.append('event_date', dateInput ? dateInput.value : '');
                if (checkboxInput && checkboxInput.checked) {
                    formData.append('exit_before_event', 'on');
                }

                const response = await fetch('/markets/event-settings', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Failed to save settings for: ${question}`);
                }

                // Update the original values
                if (dateInput) {
                    dateInput.dataset.original = dateInput.value;
                }
                if (checkboxInput) {
                    checkboxInput.dataset.original = checkboxInput.checked ? 'true' : 'false';
                }
            }
        }

        // Reset state
        changedSettings = {};
        hasUnsavedChanges = false;
        saveBtn.style.display = 'none';
        saveBtn.textContent = 'Save Changes';
        saveBtn.disabled = false;

    } catch (error) {
        alert('Error saving changes: ' + error.message);
        saveBtn.textContent = 'Save Changes';
        saveBtn.disabled = false;
    }
}

// Warn before leaving with unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return e.returnValue;
    }
});
</script>
{% endif %}
{% endblock %}
